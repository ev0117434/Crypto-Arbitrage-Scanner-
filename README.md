# Binance Prices Fetcher 
## Структура проекта

Три уровня:

1. Источники цен  
    CCXT Pro коннектится к 5 биржам (Binance, Bybit, OKX, MEXC, BingX), к споту и фьючам, и выдаёт поток тиков.
    
2. Хранилище цен (`prices.py`)  
    Централизованный модуль хранения последних цен в формате:  
    `[биржа, рынок (spot/futures), символ, bid, ask, ts]`.
    
3. Аналитика арбитража  
    Скрипт читает данные из `prices.py`, сравнивает спот (биржа A) vs фьючерс (биржа B), считает спред и пишет сигналы в консоль.
    

---

### 2. Модули по слоям

#### A. Конфигурация и базовая инфраструктура

1. `config.yaml`  
    Файл-конфиг:
    
    - список бирж (Binance, Bybit, OKX, MEXC, BingX);
        
    - включённые рынки по каждой бирже (spot / futures);
        
    - параметры CCXT Pro (rate limit, таймауты, перезапуски);
        
    - параметры арбитража (минимальный спред, какие комбинации A→B считать).
        
2. `config_loader.py`
    
    - Читает `config.yaml`.
        
    - Преобразует в простые структуры (например, словари или dataclasses).
        
    - Даёт удобный доступ к настройкам для всех остальных модулей.
        
3. `logging_setup.py` (опционально, но удобно)
    
    - Настройка логирования (уровень, формат, файлы логов).
        
    - Используется всеми модулями, чтобы не дублировать настройки.
        

---

#### B. Описание бирж и рынков

4. `exchanges_registry.py`
    
    - Карта бирж: человекочитаемое имя ↔ CCXT Pro ID (например, `binance`, `bybit`).
        
    - Настройки по умолчанию для каждой биржи:
        
        - какие типы рынков поддерживаются (`spot`, `swap`/`future`);
            
        - нужные опции CCXT Pro (`defaultType`, `options` и т.п.).
            
    - Единое место, где ты контролируешь, как именно и с какими параметрами создаётся клиент для каждой биржи.
        
5. `market_types.py`
    
    - Простое перечисление/константы для типов рынка: `SPOT`, `FUTURES`.
        
    - Логика маппинга к тому, как это называется в конкретной бирже (например, `swap` vs `future`).
        

---

#### C. Вселенная символов (что и где торгуется)

6. `symbols_universe.py`  
    Назначение: построить список символов для стриминга и арбитража.
    
    Основные задачи:
    
    - Через REST-часть CCXT (обычный ccxt) или CCXT Pro загрузить `markets` по каждой бирже.
        
    - Отфильтровать нужные рынки (например, только `USDT`-кроссы, только активные).
        
    - Построить:
        
        - `all_symbols[биржа][рынок] -> список символов` для стриминга;
            
        - `binance_spot_bybit_futures -> список символов`, каждая биржа имеет 2 рынка(спот и фьючерс) и мне нужны общие пары спота каждой биржи со всеми фьючерсными рынками других бирж
            
    - Нормализовать символы (использовать `BTCUSDT` как канонический вид).
        

---

#### D. Коннекторы к биржам (CCXT Pro, сбор данных)

7. `ccxtpro_factory.py`
    
    - Создаёт CCXT Pro клиенты по данным из `config_loader.py` и `exchanges_registry.py`.
        
    - Для каждого сочетания (биржа, тип рынка) возвращает и настраивает отдельный инстанс:
        
        - spot-клиент;
            
        - futures-клиент (USDT-M, swap/future в зависимости от биржи).
            
    - Управляет их лайфциклом (инициализация, закрытие).
        
8. `streams_spot.py`
    
    - Управляет стримами CCXT Pro для спотовых рынков.
        
    - Для каждой биржи (где включён spot):
        
        - подписывается на тики/ордербуки нужных символов (из `symbols_universe.py`);
            
        - на каждом апдейте извлекает `bid`, `ask`, `timestamp` из объекта CCXT Pro;
            
        - формирует стандартное сообщение `[биржа, 'spot', символ, bid, ask, ts]`;
            
        - передаёт его в `prices.py` (см. ниже).
            
9. `streams_futures.py`
    
    - Аналогично `streams_spot.py`, но:
        
        - создаёт futures-клиента через `ccxtpro_factory.py`;
            
        - подписывается на фьючерсные/перпетуальные рынки;
            
        - формирует `[биржа, 'futures', символ, bid, ask, ts]`;
            
        - передаёт в `prices.py`.
            
10. `streams_manager.py`
    
    - Оркестрирует запуск всех стримов:
        
        - поднимает все таски CCXT Pro (spot + futures, все биржи);
            
        - следит за перезапусками при ошибках (реконнекты, таймауты);
            
        - следит, чтобы стримы не блокировали друг друга.
            

---

#### E. Хранилище цен (центр проекта)

11. `prices.py`  
    Это тот самый отдельный скрипт/модуль-хранилище.
    

Назначение:

- Принять поток цен от `streams_spot.py` и `streams_futures.py`.
    
- Хранить последние значения по ключу `(биржа, рынок, символ)` в памяти.
    
- Внутренне можно держать структуру типа:  
    `store[(exchange, market_type, symbol)] = {bid, ask, ts}`.
    
- Внешний интерфейс:
    
    - функция обновления (обновить запись из сообщения `[биржа, рынок, символ, bid, ask, ts]`);
        
    - функции чтения:
        
        - получить цену конкретного `(биржа, рынок, символ)`;
            
            

---

#### F. Арбитражная логика и точка входа

12. `arb_spot_futures.py`  
    Модуль с логикой сравнения цен.
    

Основная идея:

- Работает поверх `prices.py`, не общается напрямую с CCXT Pro.
    
- Для каждого символа из `common_symbols['futures']`:
    
    - забирает из `prices.py`:
        
        - цены спота по всем биржам;
            
        - цены фьючерсов по всем биржам;
            
    - перебирает пары (биржа A spot, биржа B futures);
        
    - условие сигнала: спотовая цена на бирже A ниже фьючерсной цены на бирже B  
        (как правило, сравнивать ask spot vs bid futures);
        
    - считает спред в %:  
        `(futures_price - spot_price) / spot_price * 100`;
        
    - если спред ≥ порога из конфига — выводит сообщение в консоль:
        
        - какая пара;
            
        - какие биржи (A, B);
            
        - цены;
            
        - спред в % и абсолютный.
        
        Bybit spot → Binance futures: 
        SOLUSDT 
	    157.40 → 160.11 | 1.72%
   

13. `main.py`  
    Точка входа для всего проекта.
    

Последовательность шагов:

- загрузить конфиг (`config_loader.py`);
    
- инициализировать логирование (`logging_setup.py`);
    
- собрать вселенную символов (`symbols_universe.py`);
    
- поднять хранилище `prices.py`;
    
- запустить менеджер стримов (`streams_manager.py` → `streams_spot.py` + `streams_futures.py`);
    
- запустить задачу арбитражного сканера (`arb_spot_futures.py`), который периодически читает данные из `prices.py` и пишет сигналы в консоль.
    

---

### 3. Краткий поток данных

1. `main.py` → поднимает всё.
    
2. `streams_spot.py` / `streams_futures.py` → через CCXT Pro получают тики и формируют `[биржа, рынок, символ, bid, ask, ts]`.
    
3. Эти сообщения передаются в `prices.py`, который обновляет in-memory хранилище.
    
4. `arb_spot_futures.py` регулярно читает данные из `prices.py`, сравнивает спот A vs фьючерс B, считает спред и пишет сигналы в консоль.
    
## Быстрый старт
1. Установите зависимости: `pip install -r requirements.txt`.
2. Запустите сканер: `python main.py`.

Скрипт загрузит рынки спота и фьючерсов по биржам Binance, Bybit, OKX, MEXC и BingX, выберет общие USDT-пары, соберёт цены тикеров и выведет в консоль ситуации, где спотовая цена ниже фьючерсной и спред превышает порог `min_spread_percent` из `config.yaml`.
